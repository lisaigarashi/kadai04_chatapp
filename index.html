<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>Firebase_version9_RealtimeDB(G'sACADEMYåˆå­¦è€…ç”¨ã‚µãƒ³ãƒ—ãƒ«)</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <h1>Let's chat!</h1>
    </header>

    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->
    <!-- ãƒ†ã‚¯ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«æ‰“ã¡è¾¼ã¾ã‚ŒãŸå†…å®¹ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã€output keyã§å–å¾—ã—è¡¨ç¤ºã™ã‚‹ -->

    <div>
        <!-- åå‰ã‚’å…¥åŠ›å¾Œã€åå‰ã®è¡¨ç¤º -->
        <div id="name"> Name:<input type="text" id="uname"> </div>
        <div>
            <!-- ä¼šè©±ã®å†…å®¹ -->
            <textarea id="text" ></textarea>
            <!-- <textarea id="text" cols="30" rows="10"></textarea> -->
            <!-- å…¥åŠ›ã—ãŸæ™‚åˆ»ã®è¡¨ç¤º -->
           <div id="time"></div>
            <!-- é«˜ã•300pxã§å›ºå®šã€‚300pxè¶…ãˆãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ã‚ã‚‹ -->
            <button id="send">é€ä¿¡</button>
        </div>
        <!-- é•·ããªã£ãŸã‚‰è‡ªå‹•çš„ã«èª¿æ•´ã™ã‚‹ã‚ˆã†ã«cssã§é«˜ã•ãªã©ã‚’èª¿æ•´ -->
        <div id="output" style="overflow:auto; height: 300px;"></div>
    </div>
    <footer>
        <p>Â©Let`s chat ltd.2024</p>
    </footer>
    <!--/ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->



    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- JQuery -->


    <!--** ä»¥ä¸‹Firebase **-->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        //ä»¥ä¸‹ã‚’ä½¿ã†å®£è¨€ï¼ˆverãŒå¤‰ã‚ã£ã¦ã„ã‚‹ã‹ã‚‰ï¼‰å¿…è¦ã€‚ä»¥ä¸‹ã®é–¢æ•°ä»¥å¤–ã¯ä½¿ç”¨ä¸å¯
        import { getDatabase, ref, push, set, update, onChildAdded, remove, onChildChanged, onChildRemoved }
            from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒ†ãƒ©ãƒ«ã®ç”Ÿæˆï¼ˆfirebaseè¨­å®šæƒ…å ±ã‚’å«ã‚“ã§ã„ã‚‹ï¼‰
     // ï¼ˆkeyã¨å€¤ã®ãƒšã‚¢ã«ãªã£ã¦ã„ã‚‹ï¼‰
    //  firebaseApiã‹ã‚‰export
     import firebaseConfig from "./firebaseApikey.js";
        console.log(firebaseConfig);

        // Initialize Firebase
        // ä¸Šè¨˜ã®firebaseConfigã«æ¥ç¶šã™ã‚‹
        const app = initializeApp(firebaseConfig);

        const db = getDatabase(app);
        // Realtime DBã«æ¥ç¶š
        const dbRef = ref(db, "chat");
        // RealtimeDBå†…ã®"chat"ã‚’ä½¿ã†
        // ç¾åœ¨æ—¥æ™‚ã‚’è¡¨ç¤ºã™ã‚‹
        const nowTime=new Date();
        // è¥¿æš¦ã‚’å–ã‚‹
        const nowYear=nowTime.getFullYear();
        // ä½•æœˆã‚’ã¨ã‚‹(0ï½å§‹ã¾ã‚‹ã®ã§å¿…ãš+1ã‚’ã™ã‚‹)
        const nowMonth=nowTime.getMonth()+1;
    // ä½•æ—¥ã‚’å–ã‚‹
        const nowDate=nowTime.getDate();
        // æ™‚é–“ã ã‘ã‚’å–ã‚Šå‡ºã™
        const nowHour=nowTime.getHours();
        // åˆ†ã ã‘å–ã‚Šå‡ºã™
        const nowMin=nowTime.getMinutes();
        // ç§’ã ã‘ã‚’å–ã‚Šå‡ºã™
        // const nowSec=nowTime.getSeconds();

        

        const timemsg=`${nowYear}.${nowMonth}.${nowDate}.${nowHour}:${nowMin}`;



        $("#time").html(timemsg);
        // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å…¥åŠ›ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã©ã‚’
        $("#send").on("click", function () {
            // objectã‚’ä½œã‚‹
            const msg = {
                uname: $("#uname").val(),
                text: $("#text").val(),
                nowTime:timemsg,
              
                
            }
            // ä½œã£ãŸobjectã‚’realtimeDBå†…ã«æ ¼ç´ã—ã¦ã„ã
            const newPostRef = push(dbRef);
            // uniqueãŒç”Ÿæˆã•ã‚Œã€chatã®ä¸­ã«ä¿å­˜ã•ã‚Œã‚‹
            // unique keyã«ãªã‚‰ãªã„ã¨ä¸Šæ›¸ãã•ã‚Œã¦ã„ã
            set(newPostRef, msg);
            console.log(newPostRef, msg);


        });
        // ãƒ‡ãƒ¼ã‚¿å—ä¿¡:å‡¦ç†ã‚’è¨˜è¿°
        // onChildAdded()ã‚’ä½¿ã„é€ä¿¡ã—ã¦ãã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ç›£è¦–
        onChildAdded(dbRef, function (data) {
            const msg = data.val();
            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå¤‰æ•°ã®å–å¾—ã—ãªã„ã¨å‹•ã‹ãªã„
            const key = data.key;
            // ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã®å–å¾—
            // å‰Šé™¤ã™ã‚‹éš›ã«å¿…é ˆ
            let h = '<p id="' + key +'">';
                // æ™‚é–“ã®è¡¨ç¤ºï¼ˆæœ¬æ—¥ã®æ—¥ä»˜ï¼‰
           
                h += '<span contentEditable="true" id="'+ key +'_update">' + msg.nowTime+ '</span>';
                h+='<br>';
                h +=msg.uname;
            // msgã‹ã‚‰nameã‚’å–ã£ã¦ãã‚‹
            // æ”¹è¡Œ
            h+='<br>';
            // ä¸­ã«å…¥ã£ã¦ã„ã‚‹è¦ç´ ãŒç·¨é›†å¯èƒ½(contentEditable=true)ã§ã‚ã‚Œã°ã€æ›´æ–°ã—ã¦æƒ…å ±ã‚’textã¨ã—ã¦å–ã‚‹
            h += '<span contentEditable="true" id="'+ key +'_update">' + msg.text + '</span>';
            
            // msgã‹ã‚‰textã‚’ã¨ã£ã¦ãã‚‹
            // å‰Šé™¤
            h += '<span class="remove" data-key="'+ key +'">ğŸš®</span>'
            // æ›´æ–°
            h += '<span class="update" data-key="'+ key +'">ğŸ†™</span >'
            h += '</p>';
            $("#output").prepend(h);
            // outputã«ä¸Šã‹ã‚‰é †ã«å…¥ã‚Œã¦ã„ãï¼ˆæ–°ã—ã„ã‚‚ã®ã¯ä¸‹ã«å…¥ã‚‹ä»•çµ„ã¿ï¼‰

        });

        // å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
        $("#output").on("click",".remove",function(){
            const key=$(this).attr("data-key");
            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ã‹ã‚‰data-keyå±æ€§ã®å€¤ã‚’å–å¾—ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®è­˜åˆ¥å­ï¼‰
            const remove_item=ref(db,"chat/"+key);
            // å–å¾—ã—ãŸä¸Šè¨˜ã®keyã‚’åˆ©ç”¨ã—ã¦firedabaseå†…ã®chatã«ã‚ã‚‹æƒ…å ±ã‚’å‰Šé™¤
            remove(remove_item);
            // ãƒ‡ãƒ¼ã‚¿å‰Šé™¤é–¢æ•°

        });
        // å‰Šé™¤å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
        onChildRemoved(dbRef,(data)=>{
            $("#"+data.key).remove();
            // chatå†…ã®htmlã«è¡¨ç¤ºã•ã‚Œã¦ã„ãŸå†…å®¹ã‚’å‰Šé™¤
        
        });
        // æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
        $("#output").on("click",".update",function(){
            const key=$(this).attr("data-key");
            update(ref(db,"chat/"+key),{
                text:$("#"+key+'_update').html()
            });
        });
        // æ›´æ–°å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
        onChildChanged(dbRef,(data)=>{
            $("#"+data.key+'_update').html(data.val().text);
            $("#"+data.key+'_update').fadeOut(800).fadeIn(800);
        });





        

    </script>











</body>

</html>